name: Java brXM CI

on:
  workflow_call:
    inputs:
      run-demo-build:
        description: "Whether to run the demo module build"
        type: boolean
        default: false
      demo-pom-path:
        description: "Path to the demo module pom.xml"
        type: string
        default: "demo/pom.xml"
    secrets:
      BR_MAVEN_USERNAME:
        required: true
      BR_MAVEN_PASSWORD:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Remove committed docs/ if present
        if: github.event_name != 'pull_request'
        run: |
          if [ -n "$(git ls-files docs/)" ]; then
            echo "Found tracked docs/ — removing from source branch"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git rm -rf docs/
            git commit -m "chore: remove generated docs/ from source branch"
            git push
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>bloomreach-maven2</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-forge</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-enterprise</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>bloomreach-repos</id>
                <activation>
                  <activeByDefault>true</activeByDefault>
                </activation>
                <repositories>
                  <repository>
                    <id>bloomreach-maven2-enterprise</id>
                    <name>Bloomreach Maven 2 Enterprise Repository</name>
                    <url>https://maven.bloomreach.com/repository/maven2-enterprise/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
          </settings>
          EOF
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Verify versions are aligned
        run: |
          if [ ! -f "${{ inputs.demo-pom-path }}" ]; then
            echo "No demo pom found at '${{ inputs.demo-pom-path }}' — skipping version check"
            exit 0
          fi
          ROOT_VERSION=$(awk -F'[<>]' '/<parent>/,/<\/parent>/{next} /<version>/{print $3; exit}' pom.xml)
          DEMO_VERSION=$(awk -F'[<>]' '/<parent>/,/<\/parent>/{next} /<version>/{print $3; exit}' "${{ inputs.demo-pom-path }}")
          echo "Root: $ROOT_VERSION, Demo: $DEMO_VERSION"
          if [ "$ROOT_VERSION" != "$DEMO_VERSION" ]; then
            echo "ERROR: Root version '$ROOT_VERSION' does not match demo version '$DEMO_VERSION'"
            exit 1
          fi

      - name: Build and test
        run: |
          if [ "${{ inputs.run-demo-build }}" = "true" ]; then
            mvn -B clean install
          else
            mvn -B clean verify
          fi
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Build and test demo
        if: ${{ inputs.run-demo-build }}
        run: mvn -B -f "${{ inputs.demo-pom-path }}" clean verify
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Publish test results
        if: always()
        uses: mikepenz/action-junit-report@db71d41eb79864e25ab0337e395c352e84523afe # v4
        with:
          report_paths: '**/target/surefire-reports/TEST-*.xml'

      - name: Publish coverage report
        if: always()
        uses: Madrapps/jacoco-report@50d3aff4548aa991e6753342d9ba291084e63848 # v1.7.2
        with:
          paths: '**/target/site/jacoco/jacoco.xml'
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 0
          min-coverage-changed-files: 0