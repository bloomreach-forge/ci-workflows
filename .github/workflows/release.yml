name: brXM Forge Release

on:
  workflow_call:
    inputs:
      version:
        description: "Release version (e.g. 1.2.3)"
        type: string
        required: true
      next-development-version:
        description: "Next SNAPSHOT version (e.g. 1.2.4-SNAPSHOT)"
        type: string
        required: true
      branch:
        description: "Branch to release from and push back to"
        type: string
        default: "master"
      develop-branch:
        description: "Branch to receive the next development version bump"
        type: string
        default: "develop"
      dry-run:
        description: "Skip deploy to Nexus and GitHub Release creation (for testing)"
        type: boolean
        default: false
      run-demo-build:
        description: "Whether to build and verify the demo module"
        type: boolean
        default: true
      demo-pom-path:
        description: "Path to the demo module pom.xml"
        type: string
        default: "demo/pom.xml"
      forge-readme-path:
        description: "Path to the README for forge descriptor generation (auto-detected if .forge/addon-config.yaml exists)"
        type: string
        default: "README.md"
    secrets:
      BR_MAVEN_USERNAME:
        required: true
      BR_MAVEN_PASSWORD:
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Require release branch
        if: ${{ !inputs.dry-run }}
        run: |
          if [ "${{ github.ref_name }}" != "${{ inputs.branch }}" ]; then
            echo "::error::Workflow was triggered from '${{ github.ref_name }}' but the release branch is '${{ inputs.branch }}'. Re-run this workflow from the '${{ inputs.branch }}' branch."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>bloomreach-maven2</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-forge</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-enterprise</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>bloomreach-repos</id>
                <activation>
                  <activeByDefault>true</activeByDefault>
                </activation>
                <repositories>
                  <repository>
                    <id>bloomreach-maven2-enterprise</id>
                    <name>Bloomreach Maven 2 Enterprise Repository</name>
                    <url>https://maven.bloomreach.com/repository/maven2-enterprise/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
          </settings>
          EOF
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Configure git
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: Set release version
        run: |
          mvn -B versions:set -DnewVersion="${{ inputs.version }}" -DgenerateBackupPoms=false
          if [ -f "${{ inputs.demo-pom-path }}" ]; then
            mvn -B -f "${{ inputs.demo-pom-path }}" versions:set -DnewVersion="${{ inputs.version }}" -DgenerateBackupPoms=false
          fi
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Build and test
        run: mvn -B clean install
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Build and test demo
        if: ${{ inputs.run-demo-build }}
        run: mvn -B -f "${{ inputs.demo-pom-path }}" clean verify
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Deploy to Forge repository
        if: ${{ !inputs.dry-run }}
        run: mvn -B deploy -DskipTests
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Generate forge-addon.yaml
        if: hashFiles('.forge/addon-config.yaml') != ''
        uses: bloomreach-forge/brxm-marketplace/.github/actions/generate-descriptor@v1
        with:
          config-path: .forge/addon-config.yaml
          output-path: forge-addon.yaml
          readme-path: ${{ inputs.forge-readme-path }}

      - name: Commit release files
        run: |
          git add -A
          git commit -m "release: ${{ inputs.version }}"
          git push origin HEAD

      - name: Create and push tag
        run: |
          git tag -a "${{ inputs.version }}" -m "Release ${{ inputs.version }}"
          git push origin "refs/tags/${{ inputs.version }}"

      - name: Create GitHub Release
        if: ${{ !inputs.dry-run }}
        run: |
          if [ -f forge-addon.yaml ]; then
            gh release create "${{ inputs.version }}" --generate-notes forge-addon.yaml
          else
            gh release create "${{ inputs.version }}" --generate-notes
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set next development version
        if: ${{ !inputs.dry-run }}
        run: |
          git fetch origin "${{ inputs.develop-branch }}"
          git checkout "${{ inputs.develop-branch }}"
          mvn -B -o versions:set -DnewVersion="${{ inputs.next-development-version }}" -DgenerateBackupPoms=false
          if [ -f "${{ inputs.demo-pom-path }}" ]; then
            mvn -B -o -f "${{ inputs.demo-pom-path }}" versions:set -DnewVersion="${{ inputs.next-development-version }}" -DgenerateBackupPoms=false
          fi
          git add -A
          git commit -m "chore: prepare for next development iteration ${{ inputs.next-development-version }}"
          git push origin "${{ inputs.develop-branch }}"
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}
