name: brXM Forge Release

on:
  workflow_call:
    inputs:
      run-demo-build:
        description: "Whether to build and verify the demo module"
        type: boolean
        default: true
      demo-pom-path:
        description: "Path to the demo module pom.xml"
        type: string
        default: "demo/pom.xml"
      forge-readme-path:
        description: "Path to the README for forge descriptor generation (auto-detected if .forge/addon-config.yaml exists)"
        type: string
        default: "README.md"
    secrets:
      BR_MAVEN_USERNAME:
        required: true
      BR_MAVEN_PASSWORD:
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>bloomreach-maven2</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-forge</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-enterprise</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>bloomreach-repos</id>
                <activation>
                  <activeByDefault>true</activeByDefault>
                </activation>
                <repositories>
                  <repository>
                    <id>bloomreach-maven2-enterprise</id>
                    <name>Bloomreach Maven 2 Enterprise Repository</name>
                    <url>https://maven.bloomreach.com/repository/maven2-enterprise/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
          </settings>
          EOF
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Verify version matches tag
        run: |
          POM_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          if [ "$POM_VERSION" != "${{ github.ref_name }}" ]; then
            echo "ERROR: Tag '${{ github.ref_name }}' does not match pom version '$POM_VERSION'"
            exit 1
          fi
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Verify demo version matches tag
        if: ${{ inputs.run-demo-build }}
        run: |
          DEMO_VERSION=$(mvn -f "${{ inputs.demo-pom-path }}" help:evaluate -Dexpression=project.version -q -DforceStdout)
          if [ "$DEMO_VERSION" != "${{ github.ref_name }}" ]; then
            echo "ERROR: Tag '${{ github.ref_name }}' does not match demo pom version '$DEMO_VERSION'"
            exit 1
          fi
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Build and test
        run: mvn -B clean install
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Build and test demo
        if: ${{ inputs.run-demo-build }}
        run: mvn -B -f "${{ inputs.demo-pom-path }}" clean verify
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Deploy to Forge repository
        run: mvn -B deploy -DskipTests
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Generate forge-addon.yaml
        if: hashFiles('.forge/addon-config.yaml') != ''
        uses: bloomreach-forge/brxm-marketplace/.github/actions/generate-descriptor@v1
        with:
          config-path: .forge/addon-config.yaml
          output-path: forge-addon.yaml
          readme-path: ${{ inputs.forge-readme-path }}

      - name: Create GitHub Release
        run: |
          if [ -f forge-addon.yaml ]; then
            gh release create "${{ github.ref_name }}" --generate-notes forge-addon.yaml
          else
            gh release create "${{ github.ref_name }}" --generate-notes
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
