name: Maven site to GitHub Pages

on:
  workflow_call:
    inputs:
      ref:
        description: "Commit SHA or ref to build docs from"
        required: true
        type: string
      java-version:
        description: "Java version to use"
        required: false
        type: string
        default: "17"
      docs-dir:
        description: "Directory containing generated site docs"
        required: false
        type: string
        default: "docs"
      site-profile:
        description: "Maven profile used to build the site"
        required: false
        type: string
        default: "github.pages"
    secrets:
      BR_MAVEN_USERNAME:
        required: true
      BR_MAVEN_PASSWORD:
        required: true

jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: "temurin"

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>bloomreach-maven2</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-forge</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
              <server>
                <id>bloomreach-maven2-enterprise</id>
                <username>${BR_MAVEN_USERNAME}</username>
                <password>${BR_MAVEN_PASSWORD}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>bloomreach-repos</id>
                <activation>
                  <activeByDefault>true</activeByDefault>
                </activation>
                <repositories>
                  <repository>
                    <id>bloomreach-maven2-enterprise</id>
                    <name>Bloomreach Maven 2 Enterprise Repository</name>
                    <url>https://maven.bloomreach.com/repository/maven2-enterprise/</url>
                  </repository>
                </repositories>
              </profile>
            </profiles>
          </settings>
          EOF
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Build site
        run: mvn -B site -P"${{ inputs.site-profile }}"
        env:
          BR_MAVEN_USERNAME: ${{ secrets.BR_MAVEN_USERNAME }}
          BR_MAVEN_PASSWORD: ${{ secrets.BR_MAVEN_PASSWORD }}

      - name: Deploy site to gh-pages
        run: |
          if [ ! -d "${{ inputs.docs-dir }}" ]; then
            echo "ERROR: Site build did not produce ${{ inputs.docs-dir }}/ directory"
            exit 1
          fi

          mkdir -p /tmp/site-docs/
          cp -r "${{ inputs.docs-dir }}/" /tmp/site-docs/

          # Remove build artifacts so they are not picked up by git add -A
          git clean -fdx

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Switch to gh-pages (create if needed)
          git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout --orphan gh-pages
          git checkout gh-pages

          # Replace site content
          git rm -rf . 2>/dev/null || true
          cp -r /tmp/site-docs/* .
          git add -A
          git diff --staged --quiet || git commit -m "regenerate docs for ${{ inputs.ref }}"
          git push origin gh-pages
